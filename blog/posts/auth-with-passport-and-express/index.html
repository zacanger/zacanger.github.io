<!DOCTYPE html>
<html lang="en">

  <head>
    <title>Auth with Passport and Express | Zac Anger's Blog</title>
    <meta name="description" content="Auth with Passport and Express" />
    <meta name="keywords" content="['passport', 'express', 'node', 'auth', 'authentication', 'local', 'login']" />
    <meta name="twitter:description" content="Auth with Passport and Express" />
    <meta name="twitter:title" content="Auth with Passport and Express" />
    <meta property="og:description" content="Auth with Passport and Express" />
    <meta property="og:title" content="Auth with Passport and Express" />

    <meta charset="utf-8" />
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
<meta name="author" content="Zac Anger" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@zacanger" />
<meta name="twitter:creator" content="@zacanger" />
<meta name="twitter:image" content="https://zacanger.com/logo.png" />
<meta property="og:type" content="article" />
<meta property="og:site_name" content="Zac Anger's Blog" />
<meta property="og:image" content="https://zacanger.com/logo.png" />
<link rel="stylesheet" type="text/css" href="/styles.css" />
  </head>

  <body>
    <header>
      <h1><a href="/blog">Zac Anger's Blog</a></h1>
      <h2>Auth with Passport and Express</h2>
      <h3>2016-01-23</h3>
      <h4><small>Tagged: passport, express, node, auth, authentication, local, login</small></h4>
    </header>
    <div>
      <h2>Passport/Flash Issues</h2>
<p><code>npm i -S express-flash</code>, and <code>var flash = require('express-flash')</code> in your
app. <code>app.use(flash())</code>.</p>
<p>So, make a route in your app/routes/config file, wherever you're keeping
those, something like <code>app.get('/forgot', function(req,
res){res.render('forgot', {user: req.user})})</code>, assuming you have some html
with a form that <code>POST</code>s, and input for the email.</p>
<p>This assumes <code>async</code> and <code>nodemailer</code>, plus a mailing service (like sendgrid
or gmail or whatever).</p>
<div class="highlight"><pre><span></span>app.post(&#39;/forgot&#39;, function(req, res, next){
  async.waterfall([
    function(done){
      crypto.randomBytes(20, function(err, buf){
        var token = buf.toString(&#39;hex&#39;)
        done(err, token)
      })
    },
    function(token, done){
      User.findOne({email: req.body.email}, function(err, user){
        if(!user){
          req.flash(&#39;error&#39;, &#39;no account!&#39;)
          return res.redirect(&#39;/forgot&#39;)
        }
        user.resetPasswordToken   = token
        user.resetPasswordExpires = Date.now() + 3600000
        user.save(function(err){
          done(err, token, user)
        })
      })
    },
    function(token, user, done){
      var smptTransport = nodemailer.createTransport(&#39;SMTP&#39;, {
        service: &#39;foo&#39;,
        auth: {user: &#39;your username for the service&#39;, pass: &#39;your pass for the service&#39;}
      })
      var mailOptions = {
        to: user.email,
        from: &#39;learny-app@thing.bar&#39;,
        subject: &#39;reset yer passwerd, yo&#39;.
        text: &#39;hey, click the thingy and stuff, right here, to reset yer passwerd: http://&#39; + req.headers.post + &#39;/forgot/&#39; + token &#39;\n&#39; + &#39; .&#39;
      }
      smtpTransport.sendMail(mailOptions, function(err){
        req.flash(&#39;info&#39;, &#39;email sent to &#39; + user.email + &#39; to reset yer passwyrd.&#39;)
        done(err, &#39;done&#39;)
      })
    }
  ],
  function(err){
    if(err) return next(err)
    res.redirect(&#39;/forgot&#39;)
  })
})
app.get(&#39;/reset/:token&#39;, function(req, res{
  User.findOne({resetPasswordToken: req.params.token, resetPasswordExpires: $gt: Date.now()}), function(err, user){
    if(!user){
      req.flash(&#39;error&#39;, &#39;invalid password reset token&#39;)
      return res.redirect(&#39;/forgot&#39;)
    }
    res.render(&#39;reset&#39;, {
      user.req.user
    })
  })
})
app.post(&#39;/reset/:token&#39;, function(req, res){
  async.waterfall([
    function(done) {
      User.findOne({resetPasswordToken: req.params.token, resetPasswordExpires: {$gt: Date.now()}}, function(err, user){
        if(!user){
          req.flash(&#39;error&#39;, &#39;nope, nope nope.&#39;)
          return res.redirect(&#39;back&#39;)
        }
        user.password = req.body.password
        user.resetPasswordToken = undefined
        user.resetPasswordExpires = undefined
        user.save(function(err){
          req.logIn(user, function(err){
            done(err, user)
          })
        })
      })
    },
    function(user, done){
      var smtpTransport = nodemailer.createTransport(&#39;SMTP&#39;, {
        service: &#39;quux&#39;,
        auth: {
          user: &#39;same as above&#39;,
          pass: &#39;same as above&#39;
        }
      })
      var mailOptions = {
        to: user.email,
        from: &#39;learnythingy@stuff.baz&#39;,
        subject: &#39;changed pw!&#39;,
        text: &#39;heyo,\n\n&#39; +
          &#39;account &#39; + user.email + &#39;&#39;s password was changed \n&#39;
      }
      smtpTransport.sendMail(mailOptions, function(err){
        req.flash(&#39;success&#39;, &#39;pw changed&#39;)
        done(err)
      })
    }
  ], function(err){
    res.redirect(&#39;/&#39;)
  })
})
</pre></div>

<hr />
<h2>Passport with Express and Flash--what's going on, here? (Take two.)</h2>
<p>So, a flash message is just a variable, yes? A very temporary variable. It's
stored in a session, and only available once--for the next request. If we
attempt to rerender the page (or whateber), that flash variable is <em>gone</em>. So,
here's an example of how that might work:</p>
<div class="highlight"><pre><span></span>router.post(&#39;/signup&#39;, passport.authenticate(&#39;local-login&#39;, {
  successRedirect : &#39;/profile&#39;
, failureRedirect : &#39;/signup&#39;
, failureFlash    : &#39;true&#39; // just allowing flash messages, here
}))
// passport handles auth:
passport.use(&#39;local-signup&#39;, new LocalStrategy({
  usernameField     : &#39;email&#39;
, passwordField     : &#39;password&#39;
, passReqToCallback : true // we can pass the whole request, now
},
function(req, email, password, done){
process.nextTick(function(){
    User.findOne({&#39;email&#39; : email}, function(err, user){
        if (err){
          return done(err)
        }
        if (user){
          return done(null, false, req.flash(&#39;loginMessage&#39;, &#39;sorry, no&#39;))
          } else {
            var user            = new User()
            user.local.email    = email
            user.local.password = user.generateHash(password)
            user.save(function(err){
              if (err){
                throw err
              }
              return done(null, user)
})}})})})) // hey, look, it&#39;s lisp!
// now back in our router...
router.get(&#39;/signup&#39;, function(req, res){
  res.render(&#39;signup&#39;, { message : req.flash(&#39;signupMessage&#39;)})
})
</pre></div>

<p>This is basically where we are right now. Everything <em>looks</em> like it should
work, but it totally doesn't. I think what we need here is to fix the session.</p>
<div class="highlight"><pre><span></span>app.use(session({
  secret            : config.sessionSecret
, resave            : false
, saveUninitialized : true
, cookie            : {secure : true} // _this_ is a problem!
}))
</pre></div>

<p>On a local machine, there's no HTTPS.</p>
<hr />
<p>Stack says:</p>
<div class="highlight"><pre><span></span>app.post(&#39;/login&#39;, passport.authenticate(&#39;local&#39;, {
  successRedirect: &#39;/loggedin&#39;,
  failureRedirect: &#39;/login&#39;,
  failureFlash: true
}))
</pre></div>

<p>Three things might happen here:</p>
<ul>
<li>Internal error, which Express will handle, spit out a 500</li>
<li>Invalid auth (no user, password != user.password, whatever):<ul>
<li>Here we <em>don't</em> generate an error, we just pass <code>false</code> as the user object:<ul>
<li><code>next(null, false)</code>… this triggers the <code>failureRedirect</code>, which will be a generated 401 by default.</li>
</ul>
</li>
</ul>
</li>
<li>Or, maybe there's a real user (<code>next(null, user)</code>), in which case we go to the <code>successRedirect</code>, yay!</li>
</ul>
<p>In the second case, a message could be passed as well, like <code>next(null, false,
{message: 'sorry, you lose!'})</code>. If there's that <code>failureFlash</code> up there
(which <em>is</em> optional, as it happens), and we've got <code>connect-flash</code> installed,
the message is stored in the session so you can access it for a template or
whatever.</p>
<p>Another option here would be to do things the long way (manually):</p>
<div class="highlight"><pre><span></span>app.post(&#39;/login&#39;, function(req, res, next){
  passport.authenticate(&#39;local&#39;, function(err, user, info){
    if(err){
      return next(err) // generated 500 error
    } // and now we generate some JSON to spit back regarding
    if(!user){ // auth status
      return res.send({success:false, message:&#39;auth failed, yo!&#39;})
    }
    return res.send({success:true, message:&#39;hooray, you\&#39;re in!&#39;})
  })(req, res, next)
})
</pre></div>

<p>Yet <em>another</em> potential problem here is how things are being dealth with in
the front end. Requests from the browser act according to the response. If the
browser's sending, for example, with AJAX, using jQuery (this is a very
specific example, I know), then the jQuery will be expecting JSON back, will
be <em>getting</em> HTML, won't know what to do with it, and maybe you won't know
what's going on here, because you maybe don't have a <code>.fail()</code> in your call.
…and this is getting <em>really</em> specific, based on just two things I'm reading
on Stack Overflow, so let's ditch that path, shall we? And just show a quick
code sample:</p>
<div class="highlight"><pre><span></span>app.post(&#39;/login/ajax&#39;, passport.authenticate(&#39;local-login&#39;))
// login form sent here
app.post(&#39;/login&#39;, passport.authenticate(&#39;local-login&#39;, {
  successRedirect: &#39;/profile&#39;,
  failureRedirect: &#39;/login&#39;,
  failureFlash: true
}))
// custom cb something kinda along these lines, maybe?
app.post(&#39;/login&#39;, function(req, res, next){
  passport.authenticate(&#39;local-login&#39;, function(err, user, info){
    switch (req.accepts(&#39;html&#39;, &#39;json&#39;)){
      case &#39;html&#39;:
        if(err){return next(err)}
        if(!user){return res.redirect(&#39;/login&#39;)}
        req.logIn(user, function(err){
          if(err){return next(err)}
          return res.redirect(&#39;/profile)
        })
        break
      case &#39;json&#39;:
        if(err){return next(err)}
        if(!user){return res.status(401).send({&quot;okay&quot;:false})}
        req.logIn(user, function(err){
          if(err){return res.status(401).send({&quot;okay&quot;:false})}
          return res.send({&quot;okay&quot;:true})
        })
        break
      default:
        res.status(406).send()
    }
  })(req, res, next)
})
</pre></div>
    </div>
    <footer>
  <a href="/">Zac Anger</a>
  &middot; <a href="https://github.com/zacanger/zacanger.github.io">Source</a>
</footer>
  </body>
</html>