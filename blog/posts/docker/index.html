<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico"/><title>docker notes | Zac Anger&#x27;s Blog</title><meta name="description" content="So this is a Dockerfile:"/><meta name="author" content="Zac Anger"/><meta name="keywords" content="blog,design,javascript,js,music,programming,vim,web development,writing,docker"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="twitter:card" content="summary"/><meta name="twitter:site" content="@zacanger"/><meta name="twitter:creator" content="@zacanger"/><meta name="twitter:title" content="docker notes"/><meta name="twitter:description" content="So this is a Dockerfile:"/><meta name="twitter:image" content="http://zacanger.com/logo.png"/><meta property="og:type" content="article"/><meta property="og:title" content="docker notes"/><meta property="og:description" content="So this is a Dockerfile:"/><meta property="og:site_name" content="http://zacanger.com/blog"/><meta property="og:image" content="http://zacanger.com/logo.png"/><script type="text/javascript" href="/blog/assets/highlight.pack.js"></script><link rel="stylesheet" type="text/css" href="/blog/assets/styles.css"/><link rel="stylesheet" type="text/css" href="/blog/assets/github-gist.css"/></head><body><header><h1><a href="/blog">Zac Anger&#x27;s Blog</a></h1><h2>docker notes</h2><div>26 May, 2016</div></header><div><div><p>So this is a <code>Dockerfile</code>:</p>
<pre><code class="hljs"><span class="hljs-keyword">FROM</span> ubuntu:latest
<span class="hljs-keyword">RUN</span><span class="bash"> <span class="hljs-comment"># any commands, for example</span>
</span><span class="hljs-keyword">RUN</span><span class="bash"> apt-get update
</span><span class="hljs-keyword">RUN</span><span class="bash"> apt-get dist-upgrade -y -allow-unauthenticated --fix-missing
</span><span class="hljs-keyword">RUN</span><span class="bash"> apt-get install build-essential curl
</span><span class="hljs-keyword">RUN</span><span class="bash"> curl https://gist.githubusercontent.com/isaacs/579814/raw/24f5f02b5cd1812ebb1c41a33a13a0417cccbd69/take-ownership.sh | bash
</span><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">4010</span> <span class="hljs-comment"># port to expose</span>
<span class="hljs-keyword">ENTRYPOINT</span><span class="bash"> [<span class="hljs-string">"node"</span>] <span class="hljs-comment"># thing to run when we start the image, i think</span>
</span></code></pre>
<p>and then we do something like <code>docker build -t whatwewanttocallit .</code></p>
<p>and then <code>docker run -d 4010:4010 whatwecalledit</code></p>
<p>It looks like the <code>argon:node</code> image is one that is a thing. Nodejs.org recommends it.</p>
<p>Some other Dockerfile commands (?):</p>
<pre><code class="hljs"><span class="hljs-keyword">WORKDIR</span><span class="bash"> /<span class="hljs-built_in">set</span>/working/directory/to/here/i/guess
</span><span class="hljs-keyword">COPY</span><span class="bash"> thisthing /to/here
</span><span class="hljs-keyword">CMD</span><span class="bash"> [<span class="hljs-string">"array"</span>, <span class="hljs-string">"of"</span>, <span class="hljs-string">"commands"</span>, <span class="hljs-string">"like"</span>, <span class="hljs-string">"npm"</span>, <span class="hljs-string">"start"</span>]
</span><span class="hljs-keyword">ADD</span><span class="bash"> . . <span class="hljs-comment"># add files/dirs from cwd to image</span>
</span></code></pre>
<p>The <code>-d</code> in <code>docker run -d</code> means <code>detach</code>. And <code>-p</code> as in <code>docker run -p 80:4010</code> looks obvious.</p>
<p>Some commands:</p>
<pre><code class="hljs">docker ps <span class="hljs-comment"># get container id</span>
docker logs containerid
docer exec -<span class="hljs-keyword">it</span> containerid /bin/bash <span class="hljs-comment"># enter the container</span>
</code></pre>
<p>It's totally fine to test against ports from a container (with eg <code>cURL</code>).</p>
<p>There's also a <code>node:versionnumber</code> image I think?</p>
<p>To get non-root users: <code>RUN groupadd -r app &amp;&amp; useradd -r -g app app</code>,
then when the image is run, do it with <code>-u &quot;app&quot;</code>.</p>
<p>To limit usage: <code>-m &quot;256M&quot; --memory-swap &quot;2G&quot;</code></p>
<p>An example:</p>
<pre><code class="hljs language-shell">docker run \
-e "NODE_ENV=production" \
-u "app" \
-m "256M" --memory-swap "2G" \
-w "/web/jane-com/app" \
--name "jane-com" \
node index.js
</code></pre>
<p>Installing (on nix): <code>curl https://get.docker.com/ | sh</code></p>
<p>Installing test version: <code>curl https://test.docker.com | sh</code></p>
<p>Installing dev version: <code>curl https://experimental.docker.com | sh</code></p>
<p>Compose is like fig, but from Docker.</p>
<pre><code class="hljs">pip <span class="hljs-keyword">install</span> -U docker-compose
docker-compose up -d
docker-compose <span class="hljs-keyword">stop</span>, <span class="hljs-keyword">kill</span>, rm
</code></pre>
<p>All of these just go off a YAML file, I guess.</p>
<p>Okay, based on Node's official docs we can do:</p>
<pre><code class="hljs"><span class="hljs-keyword">FROM</span> node:<span class="hljs-number">6.2</span>.<span class="hljs-number">0</span>
<span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">4010</span>

<span class="hljs-comment"># and then</span>

docker build -t jane-com .
docker <span class="hljs-keyword">run</span><span class="bash"> -it --rm -name jane-com-docker-running jane-com
</span></code></pre>
<p>To keep Docker running, throw this in your bash rc: <code>eval $(docker-machine env default)</code></p>
<p>And if you need systemd in the mix, try something like:</p>
<pre><code class="hljs">;; once docker is installed, there should already be
;; a systemd<span class="hljs-built_in"> service </span><span class="hljs-keyword">for</span> it. so you can just systemctl start docker
;; <span class="hljs-keyword">and</span> systemctl <span class="hljs-builtin-name">enable</span> docker <span class="hljs-keyword">and</span> that SHOULD be it

[Unit]
<span class="hljs-attribute">Description</span>=This is our Node<span class="hljs-built_in"> service
</span><span class="hljs-attribute">Requires</span>=docker.service
<span class="hljs-attribute">After</span>=docker.service

[Service]
<span class="hljs-attribute">Restart</span>=always
<span class="hljs-attribute">ExecStartPre</span>=/usr/bin/docker kill ournodecontainer
<span class="hljs-attribute">ExecStartPre</span>=/usr/bin/docker rm ournodecontainer
<span class="hljs-attribute">ExecStart</span>=/usr/bin/docker <span class="hljs-builtin-name">run</span> <span class="hljs-attribute">--name</span>=ournodecontainer ournode/container
<span class="hljs-attribute">ExecStop</span>=/usr/bin/docker stop ournodecontainer

[Install]
<span class="hljs-attribute">WantedBy</span>=multi-user.target
</code></pre>
<p><strong>TO GET YOUR IMAGE INTO A TARBALL, LOCALLY</strong> (because they don't really tell you where to look for that):</p>
<pre><code class="hljs language-shell">docker export &lt;container-hash&gt; &gt; dockerimg.tar
<span class="hljs-meta">
#</span><span class="bash"> And <span class="hljs-keyword">then</span> you could just:</span>

mkdir ~/foo
tar -C ~/foo -xvf dockerimg.tar
<span class="hljs-meta">
#</span><span class="bash"> (or just use atool<span class="hljs-string">'s aunpack, much easier to remember!)</span></span>
</code></pre>
<p>Docker can take a <code>.dockerignore</code>, formatted I guess basically the same as gitignore.</p>
<p>Doing an <code>export</code> piped to an <code>import</code> essentially works like a squash, flattening all the layers,
so extraneous info (for example, creating files that later get removed) wouldn't take up extra space.</p>
<p><code>docker export</code> is for <em>containers</em>, currently running.</p>
<p><code>docker save</code> is for <em>images</em>.</p>
</div><p><a href="https://github.com/zacanger/dotcom/issues/new?title=docker notes" target="_blank">Submit a bug report</a></p></div><footer>Made by <a href="/">Zac Anger</a><br/><br/><a href="/blog/rss.xml">Feed</a> · <a href="/LICENSE.txt">License</a> · <a href="https://github.com/zacanger">GitHub</a> · <a href="https://twitter.com/zacanger">Twitter</a> · <a href="https://mastodon.social/@zacanger">Mastodon</a></footer></body></html>