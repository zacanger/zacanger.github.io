<!DOCTYPE html><html><head><meta charset="utf-8"/><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico"/><title>script to set up ec2 build agent for tc | Zac Anger&#x27;s Blog</title><meta name="description" content="This is a shell script to run on a new Ubuntu EC2 instance to get it
set up as a build agent for TeamCity, running stuff in Docker."/><meta name="author" content="Zac Anger"/><meta name="keywords" content="blog,design,javascript,js,music,programming,vim,web development,writing,ubuntu,docker,aws,teamcity"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="twitter:card" content="summary"/><meta name="twitter:site" content="@zacanger"/><meta name="twitter:creator" content="@zacanger"/><meta name="twitter:title" content="script to set up ec2 build agent for tc"/><meta name="twitter:description" content="This is a shell script to run on a new Ubuntu EC2 instance to get it
set up as a build agent for TeamCity, running stuff in Docker."/><meta name="twitter:image" content="http://zacanger.com/logo.png"/><meta property="og:type" content="article"/><meta property="og:title" content="script to set up ec2 build agent for tc"/><meta property="og:description" content="This is a shell script to run on a new Ubuntu EC2 instance to get it
set up as a build agent for TeamCity, running stuff in Docker."/><meta property="og:site_name" content="http://zacanger.com/blog"/><meta property="og:image" content="http://zacanger.com/logo.png"/><script type="text/javascript" href="/blog/assets/highlight.pack.js"></script><link rel="stylesheet" type="text/css" href="/blog/assets/styles.css"/><link rel="stylesheet" type="text/css" href="/blog/assets/github-gist.css"/></head><body><header><h1><a href="/blog">Zac Anger&#x27;s Blog</a></h1><h2>script to set up ec2 build agent for tc</h2><div>06 July, 2016</div></header><div><div><p>This is a shell script to run on a new Ubuntu EC2 instance to get it
set up as a build agent for TeamCity, running stuff in Docker.</p>
<pre><code class="hljs language-shell"><span class="hljs-meta">#</span><span class="bash">!/usr/bin/env bash</span>
<span class="hljs-meta">
#</span><span class="bash"> start with a t2.large (or maybe medium) ec2 instance</span>
<span class="hljs-meta">#</span><span class="bash"> ubuntu, preferably 16.x</span>
<span class="hljs-meta">#</span><span class="bash"> needs to have semi-open network access and public IP</span>
<span class="hljs-meta">#</span><span class="bash"> to be able to update packages and talk to docker and your</span>
<span class="hljs-meta">#</span><span class="bash"> build server</span>
<span class="hljs-meta">#</span><span class="bash"> after running this and registering the agent on the TC</span>
<span class="hljs-meta">#</span><span class="bash"> server, just use the agent push</span>
<span class="hljs-meta">#</span><span class="bash"> or, download the zip and scp it up</span>
<span class="hljs-meta">
#</span><span class="bash"> new ubuntu instances won<span class="hljs-string">'t have pw on default user (ubuntu)</span></span>
sudo su

apt-get update

apt-key adv --keyserver hkp://p80.pool.sks-keyservers.net:80 --recv-keys 58118E89F3A912897C070ADBF76221572C52609D

mkdir -p /etc/apt/sources.list.d/
touch /etc/apt/sources.list.d/docker.list
echo 'deb https://apt.dockerproject.org/repo ubuntu-xenial main' &gt;&gt; /etc/apt/sources.list.d/docker.list
echo 'apt_preserve_sources_list: true' &gt;&gt; /etc/cloud/cloud.cfg

if [ command -v lxc-docker ] ; then
  apt-get purge lxc-docker -y
fi

echo "
<span class="hljs-meta">#</span><span class="bash"><span class="hljs-string"># Note, this file is written by cloud-init on first boot of an instance</span></span>
<span class="hljs-meta">#</span><span class="bash"><span class="hljs-string"># modifications made here will not survive a re-bundle.</span></span>
<span class="hljs-meta">#</span><span class="bash"><span class="hljs-string"># if you wish to make changes you can:</span></span>
<span class="hljs-meta">#</span><span class="bash"><span class="hljs-string"># a.) add '</span>apt_preserve_sources_list: <span class="hljs-literal">true</span><span class="hljs-string">' to /etc/cloud/cloud.cfg</span></span>
<span class="hljs-meta">#</span><span class="bash"><span class="hljs-string">#     or do the same in user-data</span></span>
<span class="hljs-meta">#</span><span class="bash"><span class="hljs-string"># b.) add sources in /etc/apt/sources.list.d</span></span>
<span class="hljs-meta">#</span><span class="bash"><span class="hljs-string"># c.) make changes to template file /etc/cloud/templates/sources.list.tmpl</span></span>
<span class="hljs-meta">#</span><span class="bash"><span class="hljs-string"></span></span>
<span class="hljs-meta">
#</span><span class="bash"><span class="hljs-string"> See http://help.ubuntu.com/community/UpgradeNotes for how to upgrade to</span></span>
<span class="hljs-meta">#</span><span class="bash"><span class="hljs-string"> newer versions of the distribution.</span></span>
deb http://us-east-1.ec2.archive.ubuntu.com/ubuntu/ xenial main restricted
deb-src http://us-east-1.ec2.archive.ubuntu.com/ubuntu/ xenial main restricted
<span class="hljs-meta">
#</span><span class="bash"><span class="hljs-string"># Major bug fix updates produced after the final release of the</span></span>
<span class="hljs-meta">#</span><span class="bash"><span class="hljs-string"># distribution.</span></span>
deb http://us-east-1.ec2.archive.ubuntu.com/ubuntu/ xenial-updates main restricted
deb-src http://us-east-1.ec2.archive.ubuntu.com/ubuntu/ xenial-updates main restricted
<span class="hljs-meta">
#</span><span class="bash"><span class="hljs-string"># N.B. software from this repository is ENTIRELY UNSUPPORTED by the Ubuntu</span></span>
<span class="hljs-meta">#</span><span class="bash"><span class="hljs-string"># team. Also, please note that software in universe WILL NOT receive any</span></span>
<span class="hljs-meta">#</span><span class="bash"><span class="hljs-string"># review or updates from the Ubuntu security team.</span></span>
deb http://us-east-1.ec2.archive.ubuntu.com/ubuntu/ xenial universe
deb-src http://us-east-1.ec2.archive.ubuntu.com/ubuntu/ xenial universe
deb http://us-east-1.ec2.archive.ubuntu.com/ubuntu/ xenial-updates universe
deb-src http://us-east-1.ec2.archive.ubuntu.com/ubuntu/ xenial-updates universe
<span class="hljs-meta">
#</span><span class="bash"><span class="hljs-string"># N.B. software from this repository is ENTIRELY UNSUPPORTED by the Ubuntu</span></span>
<span class="hljs-meta">#</span><span class="bash"><span class="hljs-string"># team, and may not be under a free licence. Please satisfy yourself as to</span></span>
<span class="hljs-meta">#</span><span class="bash"><span class="hljs-string"># your rights to use the software. Also, please note that software in</span></span>
<span class="hljs-meta">#</span><span class="bash"><span class="hljs-string"># multiverse WILL NOT receive any review or updates from the Ubuntu</span></span>
<span class="hljs-meta">#</span><span class="bash"><span class="hljs-string"># security team.</span></span>
deb http://us-east-1.ec2.archive.ubuntu.com/ubuntu/ xenial multiverse
deb-src http://us-east-1.ec2.archive.ubuntu.com/ubuntu/ xenial multiverse
deb http://us-east-1.ec2.archive.ubuntu.com/ubuntu/ xenial-updates multiverse
deb-src http://us-east-1.ec2.archive.ubuntu.com/ubuntu/ xenial-updates multiverse
<span class="hljs-meta">
#</span><span class="bash"><span class="hljs-string"># Uncomment the following two lines to add software from the '</span>backports<span class="hljs-string">'</span></span>
<span class="hljs-meta">#</span><span class="bash"><span class="hljs-string"># repository.</span></span>
<span class="hljs-meta">#</span><span class="bash"><span class="hljs-string"># N.B. software from this repository may not have been tested as</span></span>
<span class="hljs-meta">#</span><span class="bash"><span class="hljs-string"># extensively as that contained in the main release, although it includes</span></span>
<span class="hljs-meta">#</span><span class="bash"><span class="hljs-string"># newer versions of some applications which may provide useful features.</span></span>
<span class="hljs-meta">#</span><span class="bash"><span class="hljs-string"># Also, please note that software in backports WILL NOT receive any review</span></span>
<span class="hljs-meta">#</span><span class="bash"><span class="hljs-string"># or updates from the Ubuntu security team.</span></span>
deb http://us-east-1.ec2.archive.ubuntu.com/ubuntu/ xenial-backports main restricted universe multiverse
deb-src http://us-east-1.ec2.archive.ubuntu.com/ubuntu/ xenial-backports main restricted universe multiverse
<span class="hljs-meta">
#</span><span class="bash"><span class="hljs-string"># Uncomment the following two lines to add software from Canonical'</span>s</span>
<span class="hljs-meta">#</span><span class="bash"><span class="hljs-comment"># 'partner' repository.</span></span>
<span class="hljs-meta">#</span><span class="bash"><span class="hljs-comment"># This software is not part of Ubuntu, but is offered by Canonical and the</span></span>
<span class="hljs-meta">#</span><span class="bash"><span class="hljs-comment"># respective vendors as a service to Ubuntu users.</span></span>
<span class="hljs-meta">#</span><span class="bash"> deb http://archive.canonical.com/ubuntu xenial partner</span>
<span class="hljs-meta">#</span><span class="bash"> deb-src http://archive.canonical.com/ubuntu xenial partner</span>

deb http://security.ubuntu.com/ubuntu xenial-security main
deb-src http://security.ubuntu.com/ubuntu xenial-security main
deb http://security.ubuntu.com/ubuntu xenial-security universe
deb-src http://security.ubuntu.com/ubuntu xenial-security universe
<span class="hljs-meta">#</span><span class="bash"> deb http://security.ubuntu.com/ubuntu xenial-security multiverse</span>
<span class="hljs-meta">#</span><span class="bash"> deb-src http://security.ubuntu.com/ubuntu xenial-security multiverse</span>
" &gt; /etc/apt/sources.list

apt-get install -y apt-transport-https ca-certificates
apt-get install -y linux-image-extra-$(uname -r) --fix-missing --allow-unauthenticated
apt-get install -y default-jdk unzip docker-engine --fix-missing --allow-unauthenticated
apt-get dist-upgrade -y --allow-unauthenticated --fix-missing
apt-get autoremove
apt-get purge

systemctl daemon-reload
systemctl enable docker
systemctl start docker

echo "
<span class="hljs-meta">#</span><span class="bash">!/usr/bin/env bash</span>

while true
do
  sleep 86400
  docker rmi `docker images -aq`
done
" &gt; ~/docker-cleanup.sh

chmod +x ~/docker-cleanup.sh
nohup ~/docker-cleanup.sh &amp;
</code></pre>
</div><p><a href="https://github.com/zacanger/dotcom/issues/new?title=script to set up ec2 build agent for tc" target="_blank">Submit a bug report</a></p></div><footer>Made by <a href="/">Zac Anger</a><br/><br/><a href="/blog/rss.xml">Feed</a> · <a href="/LICENSE.txt">License</a> · <a href="https://github.com/zacanger">GitHub</a> · <a href="https://twitter.com/zacanger">Twitter</a> · <a href="https://mastodon.social/@zacanger">Mastodon</a></footer></body></html>